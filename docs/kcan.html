
<!-- saved from url=(0026)http://vdiag.net/kcan.html -->
<html class="gr__vdiag_net"><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1251">

<link rel="stylesheet" type="text/css" href="./kcan_files/stl.css">
</head>
<body data-gr-c-s-loaded="true">
 <table border="0" cellpadding="0" cellspacing="0" width="100%">
  <tbody><tr>
   <td class="box_top">Обзор адаптера VAG K+CAN Commander 1.4</td>
  </tr>
 <tr>
  <td class="box1">
    <table class="text">
     <tbody><tr><td>
&nbsp;&nbsp;&nbsp;<b>VAG K+CAN Commander 1.4</b>, также как и ELM327 представляет собой один из простейших адаптеров с микроконтроллером на 
борту. <b>Важное отличие от ELM327 в данном адаптере в том, что работа с KL-линиями осуществляется напрямую, помимо микроконтроллера, аналогично 
простому K-Line адаптеру</b>. Следовательно адаптер на железном уровне поддерживает не только стандартные протоколы ISO-9141 и ISO-14230 
как ELM327, но и любые другие протоколы, работающие на KL-линиях. <a href="http://vdiag.net/drv.html">ДРАЙВЕРА</a> к адаптеру.<br><br>
     <img src="./kcan_files/kcana0.PNG" border="0" align="center"><br>
     <img src="./kcan_files/BKKCAN0.PNG" border="0" align="center"><br><br>
     
&nbsp;&nbsp;&nbsp;Микроконтроллер данного адаптера позволяет работать с протоколами на основе CAN-шины (контакты 6 и 14 на раземе стандарта J1962). В спецификации
адаптера указывается, что адаптер работает с протоколами CAN TP2.0, CAN TP1.6. В реальности команды адаптера расчитаны только прием и передачу
8-байтных CAN-посылок, без реализации протоколов верхнего уровня - таких как CAN TP2.0, CAN TP1.6, использующихся в автомобилях концерна VAG.
Таким образом сами протоколы CAN TP2.0 и CAN TP1.6 реализованы не в адаптере, а в программном обеспечении, идущим с данным адаптером в комплекте.
Такая реализация позволяет использовать данный адаптер совместно с программным обеспечением, реализующим любой другой протокол высокого уровня на 
основе шины CAN, в частности ISO-15765, использующийся в автомобилях Toyota, Nissan и т.д.<br>
&nbsp;&nbsp;&nbsp;Переключение режима работы "напрямую" для KL-линий и через микроконтроллер для линий CAN осуществляется сигналом COM-порта RTS. 
Схемотехника адаптера следующая:<br><br> 
     <img src="./kcan_files/kcanp1.PNG" border="0" align="center"><br>
     <img src="./kcan_files/kcanp2.PNG" border="0" align="center"><br>
     <img src="./kcan_files/BKCAN1.PNG" border="0" align="center"><br>
     <img src="./kcan_files/BKCAN2.PNG" border="0" align="center"><br>
     <img src="./kcan_files/BKKCAN1.PNG" border="0" align="center"><br>
     <img src="./kcan_files/BKKCAN2.PNG" border="0" align="center"><br><br>
&nbsp;&nbsp;&nbsp;Основные узлы - микросхемы FT232RL (отличный преобразователь USB-COM); микроконтроллер PIC18F258-I/SO (PIC18LF2685-I/SO) + драйвер CAN MCP2551I (реализация CAN-протокола);
микросхема LM339 (выходные каскады для K и L линий); микросхема 74HC125D + транзистор 2N7002 (для реализации переключения режимов KL/CAN). 
Применение кварца на 10MHz говорит о повышеном быстродействии по сравнению с ELM327 (где используется кварц 4MHz).<br>
&nbsp;&nbsp;&nbsp;Для обмена информацией с компьютером в режиме работы адаптера через МК (с CAN-протоколами) используется скорость 833333 бит/сек. Обращаю внимание, что
это не скорость CAN-потока, а скорость обмена между адаптером и компьютером. Как уже упоминалось выше, режимы работы адаптера переключаются сигналом COM-порта RTS. 
При RTS=OFF адаптер работает как обычный K-LINE адаптер. При RTS=ON включается в работу МК. Сигнал COM-порта DTR осуществляет сброс микроконтроллера (DTR=ON переводит МК в режим сброса).<br>
&nbsp;&nbsp;&nbsp;Запросы от компьютера к адаптеру и ответы адаптера компьютеру в HEX-виде можно записать в общем виде следующим образом:<br><br>
<b>NN DL [DATA BYTES]</b><br><br>
где NN (1 байт) - номер команды, DL (1 байт) - длина оставшейся части сообщения в байтах и [DATA BYTES] - байты данных.
Если адаптер поддерживает команду, то на запрос с данной командой должен придти ответ с одноименным номером команды.<br>
&nbsp;&nbsp;&nbsp;Команды (в HEX-виде), поддерживаемые адаптером, следующие:<br><br>
1. <b>Установка скорости CAN-потока 500кбит/сек (устарело)</b><br>
<b>Запрос:</b>50 00<br>
<b>Ответ:</b>50 00<br>
<b>Примечание:</b> Данная команда похоже устарела, так как используется только в программном обеспечении VAG K+CAN Commander 1.4, но самим 
адаптером не поддерживается. В новых версиях программ VAG K+CAN Commander в данном случае используется команда C0 00. Похоже, что китайцы 
хоть и пишут на адаптере, что он для версии 1.4, на самом деле этот же адаптер будет работать и с более высокими версиями VAG K+CAN Commander.
Также обращаю внимание, что после сброса МК скорость 500кбит/сек устанавливается по умолчанию (то есть без посылки каких-либо команд).<br><br>
2. <b>Установка скорости CAN-потока 500кбит/сек</b><br>
<b>Запрос:</b>C0 00<br>
<b>Ответ:</b>C0 00<br><br>
3. <b>Установка скорости CAN-потока 100кбит/сек</b><br>
<b>Запрос:</b>51 00<br>
<b>Ответ:</b>51 00<br><br>
4. <b>Чтение CAN-адресов, пакеты которых принимаются адаптером (2+4 адреса приема и 2 маски)</b><br>
<b>Запрос:</b>52 00<br>
<b>Ответ:</b>52 20 [ADR0_0] [ADR0_1] [ADR1_0] [ADR1_1] [ADR1_2] [ADR1_3] [MSK0] [MSK1]<br>
Пример:52 20 FF 1F FF FF FF 1F FF FF FF 1F FF FF FF 1F FF FF FF 1F FF FF FF 1F FF FF FF 1F FF FF FF 1F FF FF<br><br>
5. <b>Установка CAN-адресов, пакеты которых будут приниматся адаптером (2+4 адреса приема и 2 маски)</b><br>
<b>Запрос:</b>53 20 [ADR0_0] [ADR0_1] [ADR1_0] [ADR1_1] [ADR1_2] [ADR1_3] [MSK0] [MSK1]<br>
Пример:53 20 FC 00 00 00 FF 1F FF FF FF 1F FF FF FF 1F FF FF FF 1F FF FF FF 1F FF FF FF 1C 00 00 FF 1F FF FF<br>
<b>Ответ:</b>53 00<br><br>
&nbsp;&nbsp;&nbsp;Маска MSK0 накладывается на адреса ADR0_0 и ADR0_1. На остальные адреса накладывается маска MSK1.<br><br>
6. <b>Вывод статусов CAN</b><br>
<b>Запрос:</b>54 00<br>
<b>Ответ:</b>54 02 TXB0CON COMSTAT<br>
Пример:54 02 00 00<br><br>
&nbsp;&nbsp;&nbsp;Подробнее о байтах TXB0CON и COMSTAT можно почитать в описании МК <a href="http://ww1.microchip.com/downloads/en/DeviceDoc/41159e.pdf">PIC18F258</a><br><br>
7. <b>Установка скорости CAN-потока</b><br>
<b>Запрос:</b>55 03 BRGCON1 BRGCON2 BRGCON3<br>
Пример:55 03 03 FA 07 - Установка скорости 250кбит/сек<br>
<b>Ответ:</b>55 00<br><br>
&nbsp;&nbsp;&nbsp;Подробнее о байтах BRGCON1, BRGCON2, BRGCON3 можно почитать в описании МК <a href="http://ww1.microchip.com/downloads/en/DeviceDoc/41159e.pdf">PIC18F258</a>.
Упрощенно, скорость задается следующим образом: BRGCON2=0xFA, BRGCON3=0x07, BRGCON1=(1000000/Speed)-1.<br><br>
8. <b>Установка скорости CAN-потока 100кбит/сек</b><br>
<b>Запрос:</b>56 01 XX, где при XX=04 скорость не меняется, а при XX&lt;&gt;04 - меняется на 100кб/сек<br>
<b>Ответ:</b>56 00<br><br>
9. <b>Передача CAN-пакета</b><br>
<b>Запрос:</b>60 <h10 style="color:blue">DL</h10> <h10 style="color:red">[TADR]</h10> <h10 style="color:green">[DATA BYTES]</h10> 
(пример 60 <h10 style="color:blue">0C</h10> <h10 style="color:red">FC 00 00 00</h10> <h11 style="color:green">03 A2 06 01 00 00 00 00</h11>)<br>
<b>Ответ:</b>60 00<br><br>
где DL - байт количества следующих за ним данных; TADR - CAN-адрес пакета на передачу; DATA BYTES - 
байты данных CAN-пакета (от 0 до 8 байт).<br><br>
10. <b>Прием CAN-пакета</b><br>
<b>Ответ:</b>70 <h10 style="color:blue">DL</h10> <h10 style="color:red">[RADR]</h10> <h10 style="color:green">[DATA BYTES]</h10> 
(пример 70 <h10 style="color:blue">0C</h10> <h10 style="color:red">FD 00 AE 88</h10> <h11 style="color:green">07 E2 06 01 22 30 40 10</h11>)<br><br>
где DL - байт количества следующих за ним данных; RADR - CAN-адрес приемного пакета; DATA BYTES - 
байты данных CAN-пакета (от 0 до 8 байт).<br><br>
&nbsp;&nbsp;&nbsp;Каждый адрес или маска приема задается 4-хбайтной переменной [B0 B1 B2 B3].  
Адрес закодирован в байтах B0, B1, B2, B3 следующим образом:<br><br>
<table border="1" class="text">
 <tbody><tr align="center"><td colspan="5">CAN ID=11bit</td></tr>
 <tr align="center"><td>-</td><td>B0</td><td>B1</td><td>B2</td><td>B3</td></tr>
 <tr align="center"><td>CAN Addres:</td><td>[0 0 0 0 0 0 0 0]</td><td>[0 0 0 0 0 0 0 0]</td><td>[0 0 0 0 0 A10 A9 A8]</td><td>[A7 A6 A5 A4 A3 A2 A1 A0]</td></tr>
 <tr align="center"><td>Adapter:</td><td>[A10 A9 A8 A7 A6 A5 A4 A3]</td><td>[RTR 0 0 A2 A1 A0 0 0]</td><td>[0 0 0 0 0 0 0 0]</td><td>[0 0 0 0 0 0 0 0]</td></tr>
 <tr align="center"><td colspan="5">CAN ID=29bit</td></tr>
 <tr align="center"><td>-</td><td>B0</td><td>B1</td><td>B2</td><td>B3</td></tr>
 <tr align="center"><td>CAN Addres:</td><td>[0 0 0 A28 A27 A26 A25 A24]</td><td>[A23 A22 A21 A20 A19 A18 A17 A16]</td><td>[A15 A14 A13 A12 A11 A10 A9 A8]</td><td>[A7 A6 A5 A4 A3 A2 A1 A0]</td></tr>
 <tr align="center"><td>Adapter:</td><td>[A28 A27 A26 A25 A24 A23 A22 A21]</td><td>[RTR 1 0 A20 A19 A18 A17 A16]</td><td>[A15 A14 A13 A12 A11 A10 A9 A8]</td><td>[A7 A6 A5 A4 A3 A2 A1 A0]</td></tr>
</tbody></table><br>
&nbsp;&nbsp;&nbsp;Бит 7 байта B1 - признак RTR (удаленный запрос). При передаче пакета если установлен данный бит данные [DATA BYTES] не передаются. Аналогично, при приеме RTR
пакета [DATA BYTES] отсутствуют. Бит 6 байта B1 указывает величину CAN идентификатора. Если он равен 0, то ID=11бит, если 1 - то ID=29бит. Для маски данный бит, а также бит RTR 
должен быть равен 0. Также, к сожалению, приемные пакеты не содержат бит 6 адресного байта B1. Поэтому по приемному пакету нельзя определить был ли он с ID=11 или ID=29.
Кроме этого, в случае приема пакета с 11-битным идентификатором байты B2 и B3 содержат "мусор" (см. пример приемного пакета - это AE 88).<br>
Пример: Адресу CAN=7E0 соответствуют байты B0=FC B1=00 B2=00 B3=00.<br><br>
<b>Примечание:</b> В отличии от ELM327, в данном адаптере прием CAN-пакетов осуществляется постоянно, а не только после отправки CAN-пакета, и принятый 
пакет адаптер сразу же передает компьютеру. Данное преимущество позволяет создать на основе K+CAN эмулятор ECU автомобиля, что невозможно на адаптере ELM327.<br><br>
<b>ГДЕ КУПИТЬ</b><br>
1. <b><a href="http://www.aliexpress.com/w/wholesale-VAG-K-CAN-Commander-1.4.html?SearchText=VAG%2BK%2BCAN%2BCommander%2B1.4&amp;CatId=0&amp;shipCountry=ru&amp;initiative_id=SB_20140205000623&amp;isAtmOnline=n&amp;isRtl=yes&amp;SortType=price_asc&amp;filterCat=200000505,200003004,200000506&amp;groupsort=1" target="_blank">AliExpress</a></b><br>
2. <b><a href="http://www.ebay.com/sch/i.html?_odkw=VAG+K%2BCAN+Commander&amp;LH_BIN=1&amp;_sop=15&amp;_osacat=0&amp;_from=R40&amp;_trksid=p2045573.m570.l1313&amp;_nkw=VAG+K%2BCAN+Commander+Full+1.4&amp;_sacat=0" target="_blank">Ebay</a></b><br><br>
&nbsp;&nbsp;&nbsp;<b>ВНИМАНИЕ!</b> По последним данным обнаруженно, что некоторые экземпляры купленных адаптеров у людей - неработоспособны, причем странным 
образом - адаптер периодически вместо правильных CAN-пакетов принимает нулевые пакеты. <b>Причина ВЫЯСНЕНА!</b> Оказывается в данных экземплярах адаптера китайцы поставили PIC18F248 а не PIC18F258!
МК совместимые, но у первого типа МК оперативной памяти в два раза меньше, чем у второго. Прошивка же была расчитана на PIC18F258. Поэтому и такая работа адаптера. Впринципе прошивку можно поправить и 
данный тип МК тоже будет работать, но китайцы похоже этим не озадачивались. Неправильный тип МК был обнаружен в синих адаптерах. В черных адаптерах пока такого не замечалось.<br>
&nbsp;&nbsp;&nbsp;Для проверки работоспособности адаптера необходимо его разобрать и посмотреть тип МК или использовать программу "K+CAN Adapter TEST" (ссылки ниже):
     <img src="./kcan_files/kcant.PNG" border="0" align="center"><br><br>
&nbsp;&nbsp;&nbsp;Первоначально необходимо установить драйвера адаптера, выяснить на какой ком-порт прописался адаптер,
выставить данный ком-порт в настройке программы. Далее подключить адаптер к автомобилю и нажать в программе кнопку "Пуск". В программе (см. рис.) присутствуют 3 счетчика - 
"ПРД" (количество переданных пакетов), "Принято" (количество правильно принятых пакетов) и "Ошибка ПРМ" (число бракованных принятых пакетов).
В случае работоспособного адаптера, после нажатия кнопки "Пуск" должны увеличиваться только первые два счетчика! Если же увеличивается счетчик 
"Ошибка ПРМ" - то ваш адаптер неработоспособен (требуйте возврата денег). И еще - проверить можно на автомобиле любой марки, у которого есть CAN-шина.<br><br><br>
&nbsp;&nbsp;&nbsp;<b>ОЖИВЛЕНИЕ НЕРАБОТОСПОСОБНОГО VAG K+CAN Commander 1.4</b><br><br>
&nbsp;&nbsp;&nbsp;Если все же к вам пришел адаптер с МК PIC18F248 - еще не время его выбрасывать. Если у вас или у ваших знакомых есть навыки 
работы с паяльником, то адаптер с данным МК можно заставить работать.<br>
&nbsp;&nbsp;&nbsp;Для данного действия понадобятся: стационарный компьютер с железным COM-портом; два резистора 4,7кОм; резистор 10кОм; разъем DB9F (мама) для подключения к COM-порту; 
некоторое количество провода.<br>
&nbsp;&nbsp;&nbsp;1. Разбираем адаптер, на задней стороны платы обрезаем дорожку. Убеждаемся в отсутствии контакта между выв. 1 МК PIC и выв. 2 FTDI:<br>
     <img src="./kcan_files/PGMKCAN1.PNG" border="0" align="center"><br><br>
&nbsp;&nbsp;&nbsp;2. После этого собираем схему, согласно рисунка.<br>
&nbsp;&nbsp;&nbsp;3. Для прошивки используется ТОЛЬКО СТАЦИОНАРНЫЙ КОМПЬЮТЕР со ВСТРОЕННЫМ COM-портом на материнской плате!<br>
&nbsp;&nbsp;&nbsp;4. Используем программу WinPic800 (во вложении).<br>
&nbsp;&nbsp;&nbsp;5. После установки программы выбираем серию PIC 18F и тип МК - PIC18F248.<br>
&nbsp;&nbsp;&nbsp;6. Далее, в установках программы выбираем  Настройки-&gt;Адаптер. Тип адаптера -  JDM Programmer, а также устанавливаем номер ком-порта, к которому подключен наш шнурок для прошивки и сохраняем настройки.<br>
&nbsp;&nbsp;&nbsp;7. Загружаем в программу файл прошивки pic18f248.hex (во вложении).<br>
&nbsp;&nbsp;&nbsp;8. Подключаем USB-шнур адаптера K+CAN в компьютер, затем подключаем собранный шнурок для программирования в ком-порт на материнской плате.<br>
&nbsp;&nbsp;&nbsp;9. В программе выбираем Device-&gt;Определить тип Device. В открывшемся окне программа должна найти МК PIC18F248. ТОЛЬКО ПОСЛЕ ЭТОГО МОЖНО ПРИСТУПАТЬ К СЛЕДУЮЩЕМУ ПУНКТУ – ПРОШИВКА.<br>
&nbsp;&nbsp;&nbsp;10. Выбираем Device-&gt;Программировать все. Ожидаем завершения действия.<br>
&nbsp;&nbsp;&nbsp;11. Выбираем Device-&gt;Проверить все. Ожидаем завершения действия.<br>
&nbsp;&nbsp;&nbsp;12. Отключаем собранный шнурок для программирования от ком-порта а затем и USB-шнур адаптера K+CAN.<br> 
&nbsp;&nbsp;&nbsp;13. Восстанавливаем обрезанную дорожку на плате адаптера.<br>
&nbsp;&nbsp;&nbsp;14. Проверяем адаптер с помощью программы "K+CAN Adapter TEST".<br>
&nbsp;&nbsp;&nbsp;Ссылки: (<a href="http://www.unibytes.com/h5.jM0uimEYLqw-Us4P3UgBB" target="_blank">Ссылка1</a>,
<a href="http://www.share4web.com/get/byq7Y5S8Cqkr-gXIvkNLgolyiNe8vTiJ" target="_blank">Ссылка2</a>,
<a href="http://www.gigabase.com/getfile/_Ibdfi7IbK53f62MrlsWmgBB" target="_blank">Ссылка3</a>).<br><br>
     </td></tr>
    </tbody></table>
   </td>
  </tr>
 </tbody></table>


</body><span class="gr__tooltip"><span class="gr__tooltip-content"></span><i class="gr__tooltip-logo"></i><span class="gr__triangle"></span></span></html>